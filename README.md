# اسکنر IP برای V2Ray / Xray Core

این پروژه یک اسکنر ساده‌ی IP است که لیستی از IPها یا رنج‌های IP را می‌گیرد و به‌صورت موازی روی آن‌ها تست سرعت دانلود/آپلود انجام می‌دهد. هدف اصلی استفاده از این اسکنر برای ساخت کانفیگ‌های قابل استفاده با **Xray Core** (هسته‌ی V2Ray) است.

> توجه: این ابزار برای استفاده‌ی شخصی/آزمایشی طراحی شده است. مسئولیت استفاده از آن بر عهده‌ی کاربر است.

---

## قابلیت‌ها

* خواندن IPها و رنج‌ها از فایل جداگانه
* پشتیبانی از تست دانلود یا آپلود (یا هر دو)
* اجرای موازی با تعداد Thread دلخواه
* تعیین سرعت حداقل بر حسب کیلوبایت
* فایل کانفیگ Xray به‌صورت متغیر
* قابلیت انتخاب تصادفی IPها (Random Test)
* قابلیت Auto Skip برای پرش سریع از رنج‌هایی که شرایط لازم را ندارند
* سه شرط OR برای عبور از رنج بعدی:
  1. ۱۰٪ از رنج اسکن شود
  2. ۵ IP موفق از رنج پیدا شود
  3. ۳ دقیقه از اسکن رنج گذشته باشد

---

## پیش‌نیازها

* Python 3.9+
* باینری `xray` در مسیر سیستم یا اجازه برای دانلود خودکار (فقط بار اول)
* نصب بودن `curl` برای تست دانلود/آپلود
* در صورت اضافه شدن وابستگی‌های پایتونی: `pip install -r requirements.txt`

اگر `xray` روی سیستم شما نیست، اسکریپت در اجرای اول به شما پیشنهاد دانلود خودکار می‌دهد. در صورت داشتن باینری از قبل، می‌توانید مسیر کامل آن را وارد کنید.

---

## نحوه کار

ورودی‌ها به سه بخش تقسیم می‌شوند:

1. **فایل لیست IP / Range**  
2. **فایل کانفیگ Xray**  
3. **پارامترهای اجرایی** (تعداد ترد، سرعت دانلود، فعال/غیرفعال بودن Random و Auto Skip و ...)

برنامه IPها را از فایل می‌خواند، سپس برای هر IP یک تست سرعت (دانلود/آپلود) اجرا می‌کند و در صورت موفقیت، خروجی مناسب تولید می‌شود.

---

## فرمت فایل لیست IP / Range

در فایل ورودی می‌توانید هر خط را به یکی از صورت‌های زیر بنویسید:

```
192.168.1.10
10.0.0.0/24
172.16.0.1-172.16.0.100
```

* **تک IP** → مستقیم تست می‌شود
* **CIDR** → به لیست IP تبدیل می‌شود
* **Range** → از ابتدای رنج تا انتها بررسی می‌شود

---

## فایل کانفیگ Xray

فایل کانفیگ JSON به‌صورت کامل قابل تغییر است. برنامه از قالب زیر استفاده می‌کند و فقط آدرس سرور (IP) را برای هر تست جایگزین می‌کند.

مثال کامل‌تر (باید فقط مقدار `PLACEHOLDER_IP` را با IP جایگزین کند):

```json
{
  "log": {
    "loglevel": "warning"
  },
  "inbounds": [
    {
      "tag": "socks-in",
      "listen": "127.0.0.1",
      "port": 10808,
      "protocol": "socks",
      "settings": {
        "auth": "noauth",
        "udp": true,
        "ip": "127.0.0.1"
      }
    }
  ],
  "outbounds": [
    {
      "tag": "proxy-out",
      "protocol": "vless",
      "settings": {
        "vnext": [
          {
            "address": "PLACEHOLDER_IP",
            "port": 443,
            "users": [
              {
                "id": "UUID-HERE",
                "encryption": "none"
              }
            ]
          }
        ]
      },
      "streamSettings": {
        "network": "tcp",
        "security": "tls",
        "tlsSettings": {
          "serverName": "example.com"
        }
      }
    },
    {
      "tag": "direct",
      "protocol": "freedom"
    },
    {
      "tag": "block",
      "protocol": "blackhole"
    }
  ]
}
```

در فایل کانفیگ باید فقط جای IP با متن `PLACEHOLDER_IP` مشخص شود و باقی مقادیر (پورت، UUID، دامنه‌ی TLS و ...) را خودتان تنظیم کنید.

همچنین پیشنهاد می‌شود در کانفیگ، یک inbound از نوع `socks` روی `127.0.0.1:10808` داشته باشید تا اسکریپت بتواند با `curl` از طریق پراکسی تست بگیرد.

---

## پارامترهای قابل تنظیم

* `-t`/`--threads` : تعداد Thread موازی
* `-d`/`--download` : فعال کردن تست دانلود
* `-u`/`--upload` : فعال کردن تست آپلود
* `-s`/`--speed` : سرعت حداقل (KB/s) برای قبول موفقیت
* `-r`/`--random` : تست تصادفی IPها
* `-a`/`--autoskip` : فعال‌سازی Auto Skip
* `-i`/`--ip-file` : مسیر فایل IPها
* `-c`/`--config` : مسیر فایل کانفیگ Xray
* `-D`/`--download-url` : آدرس فایل تست دانلود (اختیاری، در صورت عدم ارائه از سرور محلی استفاده می‌شود)
* `-U`/`--upload-url` : آدرس تست آپلود (اختیاری، در صورت عدم ارائه از سرور محلی استفاده می‌شود)
* `-S`/`--upload-size-kb` : حجم داده‌ی تست آپلود
* `--download-bytes` : تعداد بایت دانلود در هر تست (برای جلوگیری از دانلود کامل فایل)
* `--local-test-server` : اجرای سرور تست محلی برای دانلود/آپلود
* `--local-test-host` : هاست/آی‌پی که داخل URL تولیدی قرار می‌گیرد
* `--local-test-listen` : آدرس Listen سرور تست محلی
* `--local-test-port` : پورت سرور تست محلی
* `--test-file-path` : مسیر فایل تست محلی
* `--test-file-size-mb` : حجم فایل تست محلی (MB)
* `-x`/`--xray-bin` : مسیر باینری Xray
* `-p`/`--proxy` : پراکسی محلی (پیش‌فرض socks5 روی 10808)
* `-o`/`--out` : مسیر فایل خروجی (اختیاری، اگر مشخص نشود خودکار ساخته می‌شود)

مثال اجرا:

```
python3 scanner.py \
  -i ips.txt \
  -c xray.json \
  -t 20 \
  -d \
  -s 500 \
  -r \
  -a
```

---

## منطق Auto Skip (سه شرط OR)

برای هر رنج IP، سه شرط زیر بررسی می‌شود. اگر هر کدام برقرار شود، برنامه به رنج بعدی می‌رود:

1. **۱۰٪ از IPهای رنج بررسی شوند**
2. **۵ IP موفق پیدا شوند**
3. **۳ دقیقه از زمان شروع اسکن آن رنج گذشته باشد**

---

## خروجی

* IPهایی که تست موفق داشته‌اند ذخیره می‌شوند
* رنج‌هایی که شرایط Auto Skip را داشته باشند زودتر رها می‌شوند
* در پایان، لیست نهایی IPهای موفق در خروجی چاپ و ذخیره خواهد شد
* نمایش درصد پیشرفت هر رنج در حین اسکن
* در صورت فشردن Ctrl+C، نتایج تا همان لحظه ذخیره می‌شوند
* خروجی پیش‌فرض داخل فولدر `result/` ساخته می‌شود و نام فایل با تاریخ و ساعت است (مثلاً `result/2024-05-20-13-05-42.txt`)

---

فرمت خروجی:

```
<ip>,<download_kbps KB/s>,<upload_kbps KB/s>
```

---

## نکته درباره تست دانلود/آپلود

برای جلوگیری از وابستگی به سرویس‌های عمومی و جلوگیری از پر شدن هارد، اسکریپت به‌صورت پیش‌فرض یک فایل تست محلی می‌سازد و یک سرور ساده‌ی HTTP بالا می‌آورد:

* مسیر پیش‌فرض فایل تست: `~/.json-scanner/test-files/test.bin`
* اگر فایل حذف شود، در اجرای بعدی به‌صورت خودکار دوباره ساخته می‌شود.
* اگر بخواهید دستی بسازید:
  1. فایل بالا را حذف کنید.
  2. دوباره اسکریپت را اجرا کنید (یا `--local-test-server` را بزنید) تا فایل ساخته شود.
* دانلود هر تست فقط به اندازه‌ی `--download-bytes` انجام می‌شود (پیش‌فرض 256KB) و فایل کامل دانلود نمی‌شود.
* آپلودها روی همان سرور محلی دریافت و دور ریخته می‌شوند (روی دیسک ذخیره نمی‌شوند).

اگر به هر دلیل می‌خواهید URL اختصاصی بدهید، می‌توانید `--download-url` و `--upload-url` را مشخص کنید. در غیر این صورت اسکریپت سرور محلی را فعال می‌کند.

---

## تست دانلود از صفر تا صد

این بخش توضیح می‌دهد تست دانلود در اسکنر دقیقاً چگونه اجرا می‌شود و برای راه‌اندازی‌اش چه کارهایی لازم است.

### ۱) آماده‌سازی پیش‌نیازها

قبل از اجرا مطمئن شوید این موارد آماده‌اند:

* **پایتون 3.9+** نصب باشد.
* باینری **`xray`** در مسیر سیستم باشد یا اجازه بدهید اسکریپت دفعه اول آن را دانلود کند.
* ابزار **`curl`** نصب باشد (برای انجام تست دانلود از طریق پراکسی).

### ۲) آماده‌سازی فایل تست دانلود (بدون اتصال خارجی)

اسکریپت به‌صورت پیش‌فرض یک فایل تست محلی می‌سازد و سرور HTTP داخلی را روشن می‌کند:

* فایل تست در مسیر `~/.json-scanner/test-files/test.bin` قرار می‌گیرد.
* اگر فایل حذف شود، در اجرای بعدی دوباره ساخته می‌شود.
* برای تغییر حجم فایل، از `--test-file-size-mb` استفاده کنید.
* برای محدود کردن حجم دانلود هر تست، از `--download-bytes` استفاده کنید.
* اگر اسکن شما از طریق سرورهای راه‌دور انجام می‌شود، `--local-test-host` را روی IP/دامنه‌ی عمومی همین سرور بگذارید تا همه‌ی سرورها بتوانند به فایل دسترسی داشته باشند.

### ۳) آماده‌سازی کانفیگ Xray

در فایل کانفیگ Xray:

* یک inbound از نوع **SOCKS** روی `127.0.0.1:10808` تعریف کنید.
* جای IP سرور را با `PLACEHOLDER_IP` بگذارید تا اسکریپت آن را جایگزین کند.

اینکار باعث می‌شود تمام تست‌ها از طریق پراکسی محلی Xray انجام شوند.

### ۴) اجرای اسکن با تست دانلود

نمونه اجرای کامل:

```
python3 scanner.py \
  -i ips.txt \
  -c xray.json \
  -t 20 \
  -d \
  -s 500 \
  --local-test-host YOUR_PUBLIC_IP
```

توضیح مهم پارامترها:

* `-d` تست دانلود را فعال می‌کند.
* اگر `-D` را نزنید، سرور تست محلی بالا می‌آید و URL محلی استفاده می‌شود.
* `-s` حداقل سرعت قابل قبول برای موفقیت (بر حسب KB/s).

### ۵) روند اجرای تست دانلود در برنامه

برای هر IP:

1. اسکریپت کانفیگ Xray را با جایگزینی `PLACEHOLDER_IP` می‌سازد.
2. Xray اجرا می‌شود و پراکسی محلی روی `127.0.0.1:10808` بالا می‌آید.
3. با `curl` یک درخواست دانلود از **طریق پراکسی** به URL تعیین‌شده زده می‌شود (به اندازه‌ی `--download-bytes`).
4. سرعت دریافت از خروجی `curl` استخراج می‌شود.
5. اگر سرعت دانلود >= مقدار `-s` باشد، آن IP موفق ثبت می‌شود.

### ۶) خروجی و تفسیر نتایج

خروجی نهایی به شکل زیر ذخیره می‌شود:

```
<ip>,<download_kbps KB/s>,<upload_kbps KB/s>
```

اگر فقط تست دانلود فعال باشد، مقدار آپلود صفر یا خالی خواهد بود.

### ۷) رفع خطاهای رایج

* **سرعت همیشه صفر است** → بررسی کنید Xray اجرا شده و پراکسی `socks5://127.0.0.1:10808` فعال است.
* **خطای اتصال به URL** → مطمئن شوید `--download-url` درست است و سرور قابل دسترسی است.
* **سرعت خیلی پایین** → فایل تست را روی سرور نزدیک‌تر قرار دهید یا از یک فایل بزرگ‌تر استفاده کنید.

---

## نکته مهم

این پروژه در مرحله ابتدایی است و برای توسعه بیشتر آماده می‌باشد.

اگر نیاز دارید ویژگی خاصی اضافه شود، می‌توانید در همین مخزن ادامه دهید.
